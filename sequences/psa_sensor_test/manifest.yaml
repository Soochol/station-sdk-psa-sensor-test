# Station SDK - PSA Sensor Test Sequence Manifest
# VL53L0X ToF distance sensor and MLX90640 IR thermal sensor test

name: psa_sensor_test
version: "2.0.0"
author: "Station SDK Team"
description: |
  PSA (Preconfigured Sensor Array) sensor test sequence.
  Tests VL53L0X and MLX90640 sensors via UART communication with STM32H723 MCU.

# Execution mode settings
modes:
  automatic: true
  manual: true
  cli: true

# Entry point settings
entry_point:
  module: sequence
  class: PSASensorTestSequence

# Hardware definitions
hardware:
  psa_mcu:
    display_name: "PSA MCU (STM32H723)"
    driver: drivers.psa_mcu
    class: PSAMCUDriver
    description: "STM32H723 MCU sensor test board"
    config_schema:
      port:
        type: string
        required: true
        default: "/dev/ttyUSB0"
        description: "Serial port (e.g., /dev/ttyUSB0, COM3)"
      baudrate:
        type: integer
        required: false
        default: 115200
        description: "Communication speed (bps)"
      timeout:
        type: float
        required: false
        default: 5.0
        min: 1.0
        max: 30.0
        description: "Response timeout (seconds)"

# Sequence parameters
parameters:
  # Communication settings
  port:
    display_name: "Serial Port"
    type: string
    default: "/dev/ttyUSB0"
    description: "MCU serial port (e.g., /dev/ttyUSB0, COM3)"

  baudrate:
    display_name: "Baudrate"
    type: integer
    default: 115200
    description: "Communication speed (bps)"

  timeout:
    display_name: "Timeout"
    type: float
    default: 5.0
    unit: "s"
    description: "Response timeout (seconds)"

  # VL53L0X parameters
  vl53l0x_target_mm:
    display_name: "VL53L0X Target Distance"
    type: integer
    default: 500
    min: 30
    max: 2000
    unit: "mm"
    description: "ToF sensor target distance"

  vl53l0x_tolerance_mm:
    display_name: "VL53L0X Tolerance"
    type: integer
    default: 100
    min: 1
    max: 500
    unit: "mm"
    description: "ToF sensor tolerance"

  # MLX90640 parameters
  mlx90640_target_celsius:
    display_name: "MLX90640 Target Temperature"
    type: float
    default: 25.0
    min: -40.0
    max: 300.0
    unit: "C"
    description: "IR sensor target temperature (Celsius)"

  mlx90640_tolerance_celsius:
    display_name: "MLX90640 Tolerance"
    type: float
    default: 10.0
    min: 0.1
    max: 50.0
    unit: "C"
    description: "IR sensor tolerance (Celsius)"

  # Sensor enable settings
  test_vl53l0x_enabled:
    display_name: "Enable VL53L0X Test"
    type: boolean
    default: true
    description: "Whether to run VL53L0X ToF sensor test"

  test_mlx90640_enabled:
    display_name: "Enable MLX90640 Test"
    type: boolean
    default: true
    description: "Whether to run MLX90640 IR sensor test"

  # Execution control
  stop_on_failure:
    display_name: "Stop on Failure"
    type: boolean
    default: true
    description: "Stop sequence immediately on step failure"

# Step definitions
steps:
  - name: setup
    display_name: "Setup"
    order: 0
    lifecycle: true
    description: "Hardware initialization and connection"

  - name: ping_pong
    display_name: "PING/PONG Communication Test"
    order: 1
    timeout: 10.0
    description: "Verify MCU communication"

  - name: initialize
    display_name: "Get Sensor List"
    order: 2
    timeout: 30.0
    description: "Retrieve registered sensors from MCU"

  - name: test_vl53l0x
    display_name: "VL53L0X Distance Test"
    order: 3
    timeout: 15.0
    description: "Test ToF distance sensor"

  - name: test_mlx90640
    display_name: "MLX90640 Temperature Test"
    order: 4
    timeout: 20.0
    description: "Test IR thermal sensor"

  - name: finalize
    display_name: "Finalize"
    order: 5
    timeout: 10.0
    description: "Summarize test results"

  - name: teardown
    display_name: "Teardown"
    order: 6
    lifecycle: true
    description: "Resource cleanup and disconnection"

# Python dependencies
dependencies:
  python:
    - pyserial>=3.5
